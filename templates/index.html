{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">ğŸ™ï¸ Gravar Ãudio para RelatÃ³rios</h1>
    
    <!-- BotÃµes para gravaÃ§Ã£o dos Ã¡udios de InÃ­cio e Fim -->
    <div class="d-flex justify-content-center gap-3 mb-4">
        <button id="btnGravarInicio" class="btn btn-outline-success btn-lg px-4 py-3">
            â–¶ï¸ Gravar InÃ­cio
        </button>
        <button id="btnGravarFim" class="btn btn-outline-success btn-lg px-4 py-3">
            â–¶ï¸ Gravar Fim
        </button>
    </div>
    
    <!-- Ãrea para exibir e editar as transcriÃ§Ãµes -->
    <div id="transcricoes">
        <div class="mb-4">
            <label for="textoTranscricaoInicio" class="form-label fs-5"><strong>ğŸ“ GravaÃ§Ã£o do InÃ­cio</strong></label>
            <textarea id="textoTranscricaoInicio" class="form-control shadow-sm p-3 rounded-3" rows="5" placeholder="TranscriÃ§Ã£o do Ã¡udio de inÃ­cio..."></textarea>
        </div>
        <div class="mb-4">
            <label for="textoTranscricaoFim" class="form-label fs-5"><strong>ğŸ“ GravaÃ§Ã£o do Fim</strong></label>
            <textarea id="textoTranscricaoFim" class="form-control shadow-sm p-3 rounded-3" rows="5" placeholder="TranscriÃ§Ã£o do Ã¡udio de fim..."></textarea>
        </div>
        
        <!-- BotÃ£o Concluir para finalizar a ediÃ§Ã£o -->
        <div class="d-flex justify-content-center">
            <button id="btnConcluir" class="btn btn-primary btn-lg px-5 py-3">âœ… Concluir</button>
        </div>
    </div>
    
    <!-- BotÃµes para navegaÃ§Ã£o -->
    <div id="navegacao" class="mt-5 d-flex justify-content-between">
        <a href="{{ url_for('relatorios') }}" class="btn btn-outline-primary">ğŸ“Š Ver RelatÃ³rios</a>
        <a href="{{ url_for('graficos') }}" class="btn btn-outline-primary">ğŸ“ˆ Ver GrÃ¡ficos</a>
    </div>
</div>

<!-- InclusÃ£o do script de gravaÃ§Ã£o -->
<script src="{{ url_for('static', filename='recorder.js') }}"></script>

<script>
    let currentRecording = null;

    const btnGravarInicio = document.getElementById('btnGravarInicio');
    const btnGravarFim = document.getElementById('btnGravarFim');
    const btnConcluir = document.getElementById('btnConcluir');
    const textoTranscricaoInicio = document.getElementById('textoTranscricaoInicio');
    const textoTranscricaoFim = document.getElementById('textoTranscricaoFim');

    function uploadAndGetTranscription(recordingType, audioBlob, callback) {
        let formData = new FormData();
        formData.append("audio_data", audioBlob, recordingType + "_" + Date.now() + ".wav");
        formData.append("tipo", recordingType);
        
        fetch("/processar_audio", {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            callback(data.transcricao || "Erro na transcriÃ§Ã£o");
        })
        .catch(error => {
            console.error("Erro:", error);
            callback("Erro na transcriÃ§Ã£o");
        });
    }

    function startRecording(type) {
        if (currentRecording !== null) {
            stopRecording(currentRecording);
        }

        currentRecording = type;

        const btn = type === 'inicio' ? btnGravarInicio : btnGravarFim;
        btn.classList.remove('btn-outline-success');
        btn.classList.add('btn-outline-danger');
        btn.textContent = "ğŸ”´ Gravando...";

        recorder.start();
    }

    function stopRecording(type) {
        recorder.stop().then(blob => {
            uploadAndGetTranscription(type, blob, function(transcricaoRecebida) {
                const textarea = type === 'inicio' ? textoTranscricaoInicio : textoTranscricaoFim;
                const btn = type === 'inicio' ? btnGravarInicio : btnGravarFim;

                textarea.value = transcricaoRecebida;
                btn.classList.remove('btn-outline-danger');
                btn.classList.add('btn-outline-success');
                btn.textContent = type === 'inicio' ? "â–¶ï¸ Gravar InÃ­cio" : "â–¶ï¸ Gravar Fim";
            });
        }).catch(err => {
            console.error("Erro ao parar a gravaÃ§Ã£o:", err);
        });

        currentRecording = null;
    }

    btnGravarInicio.addEventListener('click', function() {
        startRecording('inicio');
    });

    btnGravarFim.addEventListener('click', function() {
        startRecording('fim');
    });

    btnConcluir.addEventListener('click', function() {
        alert('GravaÃ§Ã£o concluÃ­da!');
    });
</script>
{% endblock %}
