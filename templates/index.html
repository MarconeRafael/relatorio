{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h1 class="text-center">Gravar Áudio para Relatórios</h1>
    
    <!-- Botões para gravação dos áudios de Início e Fim -->
    <div class="d-flex justify-content-center gap-3 mb-4">
        <button id="btnGravarInicio" class="btn btn-success btn-lg">Gravar Início</button>
        <button id="btnGravarFim" class="btn btn-success btn-lg">Gravar Fim</button>
    </div>
    
    <!-- Área para exibir e editar as transcrições -->
    <div id="transcricoes">
        <div class="mb-3">
            <label for="textoTranscricaoInicio" class="form-label"><strong>Gravação do Início</strong></label>
            <textarea id="textoTranscricaoInicio" class="form-control" rows="5" placeholder="Transcrição do áudio de início..."></textarea>
        </div>
        <div class="mb-3">
            <label for="textoTranscricaoFim" class="form-label"><strong>Gravação do Fim</strong></label>
            <textarea id="textoTranscricaoFim" class="form-control" rows="5" placeholder="Transcrição do áudio de fim..."></textarea>
        </div>
        <!-- Botão Concluir para finalizar a edição -->
        <button id="btnConcluir" class="btn btn-primary">Concluir</button>
    </div>
    
    <!-- Botões para navegar para Relatórios e Gráficos -->
    <div id="navegacao" class="mt-4 d-flex justify-content-between">
        <a href="{{ url_for('relatorios') }}" class="btn btn-primary">Ver Relatórios</a>
        <a href="{{ url_for('graficos') }}" class="btn btn-primary">Ver Gráficos</a>
    </div>
</div>

<!-- Inclusão do script de gravação -->
<script src="{{ url_for('static', filename='recorder.js') }}"></script>

<script>
    let currentRecording = null;

    const btnGravarInicio = document.getElementById('btnGravarInicio');
    const btnGravarFim = document.getElementById('btnGravarFim');
    const btnConcluir = document.getElementById('btnConcluir');
    const textoTranscricaoInicio = document.getElementById('textoTranscricaoInicio');
    const textoTranscricaoFim = document.getElementById('textoTranscricaoFim');

    function uploadAndGetTranscription(recordingType, audioBlob, callback) {
        let formData = new FormData();
        formData.append("audio_data", audioBlob, recordingType + "_" + Date.now() + ".wav");
        formData.append("tipo", recordingType);
        
        fetch("/processar_audio", {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.transcricao) {
                callback(data.transcricao);
            } else {
                callback("Erro na transcrição");
            }
        })
        .catch(error => {
            console.error("Erro:", error);
            callback("Erro na transcrição");
        });
    }

    function startRecording(type) {
        if (currentRecording !== null) {
            stopRecording(currentRecording);
        }

        currentRecording = type;

        if (type === 'inicio') {
            btnGravarInicio.classList.remove('btn-success');
            btnGravarInicio.classList.add('btn-danger');
            btnGravarInicio.textContent = "Gravando Início...";
            textoTranscricaoInicio.placeholder = "Gravando áudio de início...";
        } else if (type === 'fim') {
            btnGravarFim.classList.remove('btn-success');
            btnGravarFim.classList.add('btn-danger');
            btnGravarFim.textContent = "Gravando Fim...";
            textoTranscricaoFim.placeholder = "Gravando áudio de fim...";
        }

        // Chama a função de gravação do recorder.js
        recorder.start();
    }

    function stopRecording(type) {
        recorder.stop().then(blob => {
            uploadAndGetTranscription(type, blob, function(transcricaoRecebida) {
                if (type === 'inicio') {
                    textoTranscricaoInicio.value = transcricaoRecebida;
                    btnGravarInicio.classList.remove('btn-danger');
                    btnGravarInicio.classList.add('btn-success');
                    btnGravarInicio.textContent = "Gravar Início";
                } else if (type === 'fim') {
                    textoTranscricaoFim.value = transcricaoRecebida;
                    btnGravarFim.classList.remove('btn-danger');
                    btnGravarFim.classList.add('btn-success');
                    btnGravarFim.textContent = "Gravar Fim";
                }
            });
        }).catch(err => {
            console.error("Erro ao parar a gravação:", err);
        });

        currentRecording = null;
    }

    btnGravarInicio.addEventListener('click', function() {
        startRecording('inicio');
    });

    btnGravarFim.addEventListener('click', function() {
        startRecording('fim');
    });

    btnConcluir.addEventListener('click', function() {
        alert('Gravação concluída!');
    });
</script>
{% endblock %}
