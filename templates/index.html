{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h1 class="text-center mb-4">🎙️ Gravar Áudio para Relatórios</h1>
    
    <!-- Botões para gravação dos áudios de Início e Fim -->
    <div class="d-flex justify-content-center gap-3 mb-4">
        <button id="btnGravarInicio" class="btn btn-outline-success btn-lg px-4 py-3">
            ▶️ Gravar Início
        </button>
        <button id="btnGravarFim" class="btn btn-outline-success btn-lg px-4 py-3">
            ▶️ Gravar Fim
        </button>
    </div>
    
    <!-- Área para exibir e editar as transcrições -->
    <div id="transcricoes">
        <div class="mb-4">
            <label for="textoTranscricaoInicio" class="form-label fs-5"><strong>📝 Gravação do Início</strong></label>
            <textarea id="textoTranscricaoInicio" class="form-control shadow-sm p-3 rounded-3" rows="5" placeholder="Transcrição do áudio de início..."></textarea>
        </div>
        <div class="mb-4">
            <label for="textoTranscricaoFim" class="form-label fs-5"><strong>📝 Gravação do Fim</strong></label>
            <textarea id="textoTranscricaoFim" class="form-control shadow-sm p-3 rounded-3" rows="5" placeholder="Transcrição do áudio de fim..."></textarea>
        </div>
        
        <!-- Botão Concluir para finalizar a edição -->
        <div class="d-flex justify-content-center">
            <button id="btnConcluir" class="btn btn-primary btn-lg px-5 py-3">✅ Concluir</button>
        </div>
    </div>
    
    <!-- Botões para navegação -->
    <div id="navegacao" class="mt-5 d-flex justify-content-between">
        <a href="{{ url_for('relatorios') }}" class="btn btn-outline-primary">📊 Ver Relatórios</a>
        <a href="{{ url_for('graficos') }}" class="btn btn-outline-primary">📈 Ver Gráficos</a>
    </div>
</div>

<!-- Inclusão do script de gravação -->
<script src="{{ url_for('static', filename='recorder.js') }}"></script>

<script>
    let currentRecording = null;

    const btnGravarInicio = document.getElementById('btnGravarInicio');
    const btnGravarFim = document.getElementById('btnGravarFim');
    const btnConcluir = document.getElementById('btnConcluir');
    const textoTranscricaoInicio = document.getElementById('textoTranscricaoInicio');
    const textoTranscricaoFim = document.getElementById('textoTranscricaoFim');

    function uploadAndGetTranscription(recordingType, audioBlob, callback) {
        let formData = new FormData();
        formData.append("audio_data", audioBlob, recordingType + "_" + Date.now() + ".wav");
        formData.append("tipo", recordingType);
        
        fetch("/processar_audio", {
            method: "POST",
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            callback(data.transcricao || "Erro na transcrição");
        })
        .catch(error => {
            console.error("Erro:", error);
            callback("Erro na transcrição");
        });
    }

    function startRecording(type) {
        if (currentRecording !== null) {
            stopRecording(currentRecording);
        }

        currentRecording = type;

        const btn = type === 'inicio' ? btnGravarInicio : btnGravarFim;
        btn.classList.remove('btn-outline-success');
        btn.classList.add('btn-outline-danger');
        btn.textContent = "🔴 Gravando...";

        recorder.start();
    }

    function stopRecording(type) {
        recorder.stop().then(blob => {
            uploadAndGetTranscription(type, blob, function(transcricaoRecebida) {
                const textarea = type === 'inicio' ? textoTranscricaoInicio : textoTranscricaoFim;
                const btn = type === 'inicio' ? btnGravarInicio : btnGravarFim;

                textarea.value = transcricaoRecebida;
                btn.classList.remove('btn-outline-danger');
                btn.classList.add('btn-outline-success');
                btn.textContent = type === 'inicio' ? "▶️ Gravar Início" : "▶️ Gravar Fim";
            });
        }).catch(err => {
            console.error("Erro ao parar a gravação:", err);
        });

        currentRecording = null;
    }

    btnGravarInicio.addEventListener('click', function() {
        startRecording('inicio');
    });

    btnGravarFim.addEventListener('click', function() {
        startRecording('fim');
    });

    btnConcluir.addEventListener('click', function() {
        alert('Gravação concluída!');
    });
</script>
{% endblock %}
