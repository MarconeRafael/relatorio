{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
  <h1 class="text-center mb-4">ğŸ“‹ RelatÃ³rio de ProduÃ§Ã£o de Tarefas</h1>
  
  <form id="formRelatorio" action="{{ url_for('relatorio_bp.processar_formulario') }}" method="POST">
    {# Se nÃ£o estiver usando Flask-WTF, remova a linha abaixo #}
    {# {{ form.csrf_token }} #}
    
    <!-- Nome do Cliente com Ã¡udio -->
    <div class="mb-4">
      <label for="nomeCliente" class="form-label fs-5"><strong>ğŸ‘¤ Nome do Cliente</strong></label>
      <div class="input-group">
        <input type="text" id="nomeCliente" name="nomeCliente" class="form-control" placeholder="Digite o nome do cliente...">
        <button type="button" id="btnGravarnomeCliente" class="btn btn-outline-success">
          ğŸ™ï¸ Gravar Nome do Cliente
        </button>
      </div>
      <div class="form-text">VocÃª pode digitar ou utilizar a gravaÃ§Ã£o para preencher este campo.</div>
    </div>

    <!-- HorÃ¡rio de InÃ­cio -->
    <div class="mb-4">
      <label for="horarioInicio" class="form-label fs-5"><strong>â° HorÃ¡rio de InÃ­cio</strong></label>
      <input type="time" id="horarioInicio" name="horarioInicio" class="form-control" placeholder="08:30">
      <div class="form-text">
        Utilize o formato 24h (ex: 08:30). 
        <br>
        <small class="text-muted">Dica: Insira o horÃ¡rio exato em que a tarefa iniciou. Certifique-se de que o valor seja vÃ¡lido.</small>
      </div>
    </div>
    
    <!-- Tarefa -->
    <div class="mb-4">
      <label for="tarefa" class="form-label fs-5"><strong>ğŸ› ï¸ Tarefa</strong></label>
      <select id="tarefa" name="tarefa" class="form-select">
        <option value="" disabled selected>Selecione uma tarefa</option>
        <option value="Pintura">Pintura</option>
        <option value="Colagem de filme">Colagem de filme</option>
        <option value="Colagem de eps">Colagem de eps</option>
        <option value="Acabamento">Acabamento</option>
        <option value="Envio">Envio</option>
      </select>
      <div class="form-text">ApÃ³s selecionar, os campos de material gasto serÃ£o atualizados automaticamente.</div>
    </div>

    <!-- Material Gasto (apenas inputs, sem Ã¡udio) -->
    <div class="mb-4" id="materialGastoSection" style="display:none;">
      <label class="form-label fs-5"><strong>ğŸ›’ Material Gasto</strong></label>
      <div class="form-text mb-2">Informe a quantidade de material gasto conforme o material esperado por mÂ².</div>
      <div id="materialContainer">
        <!-- Campos serÃ£o criados dinamicamente -->
      </div>
    </div>

    <!-- Metros Quadrados -->
    <div class="mb-4">
      <label for="metrosQuadrados" class="form-label fs-5"><strong>ğŸ“ Metros Quadrados</strong></label>
      <input type="number" step="any" id="metrosQuadrados" name="metrosQuadrados" class="form-control" placeholder="Ex: 25.5">
      <div class="form-text">Informe a Ã¡rea total trabalhada em metros quadrados.</div>
    </div>
    
    <!-- HorÃ¡rio de Fim -->
    <div class="mb-4">
      <label for="horarioFim" class="form-label fs-5"><strong>â° HorÃ¡rio de Fim</strong></label>
      <input type="time" id="horarioFim" name="horarioFim" class="form-control" placeholder="17:00">
      <div class="form-text">
        Utilize o formato 24h (ex: 17:00). 
        <br>
        <small class="text-muted">Dica: O horÃ¡rio de fim deve ser posterior ao horÃ¡rio de inÃ­cio. Verifique se os valores estÃ£o corretos.</small>
      </div>
    </div>

    <!-- BotÃ£o Concluir -->
    <div class="d-flex justify-content-center">
      <button type="submit" class="btn btn-primary btn-lg px-5 py-3">âœ… Concluir</button>
    </div>
  </form>
  
  <!-- BotÃµes para navegaÃ§Ã£o -->
  <div id="navegacao" class="mt-5 d-flex justify-content-between">
    <a href="/relatorio_form/tabela" class="btn btn-outline-primary">ğŸ“Š Ver RelatÃ³rios</a>
    <a href="{{ url_for('graficos') }}" class="btn btn-outline-primary">ğŸ“ˆ Ver GrÃ¡ficos</a>
  </div>
</div>

<!-- InclusÃ£o do script de gravaÃ§Ã£o -->
<script src="{{ url_for('static', filename='recorder.js') }}"></script>
<script>
  // VariÃ¡veis para controle do Ã¡udio do nome do cliente
  let mediaRecorderNomeCliente;
  let recordedChunksNomeCliente = [];

  document.getElementById('btnGravarnomeCliente').addEventListener('click', async function() {
    const btn = document.getElementById('btnGravarnomeCliente');

    if (mediaRecorderNomeCliente && mediaRecorderNomeCliente.state === "recording") {
      // Encerra a gravaÃ§Ã£o
      mediaRecorderNomeCliente.stop();
      btn.textContent = "ğŸ™ï¸ Gravar Nome do Cliente";
    } else {
      // Inicia a gravaÃ§Ã£o
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("Seu navegador nÃ£o suporta gravaÃ§Ã£o de Ã¡udio.");
        return;
      }
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        recordedChunksNomeCliente = [];
        mediaRecorderNomeCliente = new MediaRecorder(stream);
        
        mediaRecorderNomeCliente.ondataavailable = function(e) {
          if (e.data.size > 0) {
            recordedChunksNomeCliente.push(e.data);
          }
        };

        mediaRecorderNomeCliente.onstop = function() {
          const blob = new Blob(recordedChunksNomeCliente, { type: 'audio/webm' });
          enviarAudio(blob, 'nomeCliente');
        };

        mediaRecorderNomeCliente.start();
        btn.textContent = "â¹ï¸ Encerrar GravaÃ§Ã£o";
      } catch (err) {
        console.error("Erro ao acessar o microfone: ", err);
      }
    }
  });

  // FunÃ§Ã£o para enviar o Ã¡udio para o servidor e preencher o campo com a transcriÃ§Ã£o
  function enviarAudio(blob, fieldId) {
    const formData = new FormData();
    formData.append("audio_data", blob, fieldId + "_" + Date.now() + ".webm");
    formData.append("field", fieldId);
    fetch("/processar_audio", {
      method: "POST",
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      const text = data.transcricao || "Erro na transcriÃ§Ã£o";
      document.getElementById(fieldId).value = text;
    })
    .catch(error => {
      console.error("Erro na requisiÃ§Ã£o:", error);
      document.getElementById(fieldId).value = "Erro ao enviar Ã¡udio.";
    });
  }

  // Atualiza dinamicamente os campos de Material Gasto (apenas inputs, sem Ã¡udio)
  document.getElementById('tarefa').addEventListener('change', function() {
    const tarefa = this.value;
    const materialData = {
      "Pintura": {
        "PÃ³ para Pintura branco": 150,
        "PÃ³ para Pintura preto fosco": 50,
        "PÃ³ para Pintura terracota": 50,
        "PÃ³ para Pintura preto brilhoso": 25,
        "PÃ³ para Pintura cinza": 10,
        "PÃ³ para Pintura amarelo": 10,
        "PÃ³ para Pintura vermelho": 10
      },
      "Colagem de filme": {
        "Filme": 1.03,
        "Estilete": 15,
        "Ãlcool": 5,
        "Cola Una": 140,
        "Cola Kisafix": 160
      },
      "Colagem de eps": {
        "Cola Mel": 200,
        "EPS": 1000,
        "AÃ§o": 1,
        "Luvas": 100
      },
      "Acabamento": {
        "EPS": 1000,
        "Estilete": 15
      },
      "Envio": {
        "Parafuso autobrocante": 1000,
        "Parafuso costura": 50,
        "cuminheeira": 1
      }
    }[tarefa];

    const materialContainer = document.getElementById('materialContainer');
    materialContainer.innerHTML = ""; // Limpa campos anteriores

    if (materialData && Object.keys(materialData).length > 0) {
      document.getElementById('materialGastoSection').style.display = 'block';
      for (const material in materialData) {
        // Cria um grupo de input para cada material esperado (sem botÃ£o de Ã¡udio)
        const div = document.createElement('div');
        div.className = "input-group mb-2";
        
        const span = document.createElement('span');
        span.className = "input-group-text";
        span.textContent = material + " (esperado: " + materialData[material] + " por mÂ²)";
        
        const input = document.createElement('input');
        input.type = "number";
        input.step = "any";
        input.name = "material_" + material;
        input.id = "material_" + material;
        input.className = "form-control";
        input.placeholder = "Digite a quantidade usada";

        div.appendChild(span);
        div.appendChild(input);
        materialContainer.appendChild(div);
      }
    } else {
      document.getElementById('materialGastoSection').style.display = 'none';
    }
  });
</script>
{% endblock %}
